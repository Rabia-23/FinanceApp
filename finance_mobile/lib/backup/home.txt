import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

import '../popups/add_transaction.dart'; // transaction pop-up
import '../popups/add_account.dart'; // account pop-up
import '../popups/show_budget.dart'; // budget pop-up

import '../widgets/graph.dart'; // graph widget

class HomePage extends StatelessWidget {
  const HomePage({super.key});

  @override
  Widget build(BuildContext context) {
    //final currencyFormat = NumberFormat.currency(locale: 'tr_TR', symbol: 'â‚º');

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
              showDialog(
                context: context,
                builder: (context) => const AddTransactionPopup(),
              );
        },
        backgroundColor: Colors.black87,
        shape: const CircleBorder(),
        child: const Icon(Icons.add, color: Colors.white),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ðŸ”¹ ÃœST BAR + NAVIGATION BAR
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Row(
                    children: const [
                      Icon(Icons.account_balance_wallet_outlined,
                          color: Colors.deepPurple),
                      SizedBox(width: 6),
                      Text(
                        "Finans Takip",
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                          color: Colors.deepPurple,
                        ),
                      ),
                    ],
                  ),
                  OutlinedButton.icon(
                    onPressed: () {
                      Navigator.pushReplacementNamed(context, '/');
                    },
                    icon: const Icon(Icons.logout_outlined, size: 16),
                    label: const Text("Ã‡Ä±kÄ±ÅŸ"),
                    style: OutlinedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8)),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 20),

              // ðŸ”¹ YATAY SCROLL NAV BAR
              SingleChildScrollView(
                scrollDirection: Axis.horizontal,
                child: Row(
                  children: [
                    _navButton(
                      context,
                      icon: Icons.home_outlined,
                      label: "Ana Sayfa",
                      isActive: true,
                      onTap: () {
                        Navigator.pushReplacementNamed(context, '/home');
                      },
                    ),
                    _navButton(
                      context,
                      icon: Icons.receipt_long_outlined,
                      label: "Islemler",
                      onTap: () {
                        Navigator.pushNamed(context, '/transactions');
                      },
                    ),
                    _navButton(
                      context,
                      icon: Icons.subscriptions_outlined,
                      label: "Abonelikler",
                      onTap: () {
                        Navigator.pushNamed(context, '/subscriptions');
                      },
                    ),
                    _navButton(
                      context,
                      icon: Icons.flag_outlined,
                      label: "Hedefler",
                      onTap: () {
                        Navigator.pushNamed(context, '/goals');
                      },
                    ),
                    _navButton(
                      context,
                      icon: Icons.monetization_on_outlined,
                      label: "Currency",
                      onTap: () {
                        Navigator.pushNamed(context, '/currency');
                      },
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 30),

              const Text(
                "HoÅŸ geldiniz, rabia",
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w400),
              ),
              const SizedBox(height: 10),

              // ðŸ”¹ BANKA HESAPLARI
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    "Banka HesaplarÄ±",
                    style:
                        TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                  ),

                  OutlinedButton.icon(
                    icon: const Icon(Icons.add),
                    label: const Text("Hesap Ekle"),
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(color: Colors.black87, width: 1),
                      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 14),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    ),
                    onPressed: () {
                      showDialog(
                        context: context,
                        builder: (context) => const AddAccountPopup(),
                      );
                    },
                  ),
                ],
              ),
              const SizedBox(height: 8),

              _buildBankCard("Ziraat BankasÄ±", 25000, Colors.green),
              _buildBankCard("Ä°ÅŸ BankasÄ±", 15000, Colors.blue),

              const SizedBox(height: 16),

              // ðŸ”¹ AYLIK BÃœTÃ‡E
              _buildBudgetCard(context, spent: 2109, total: 10000),

              const SizedBox(height: 16),

              // ðŸ”¹ NET DEÄžER
              _buildNetWorthCard(40000),

              const SizedBox(height: 16),

              // ðŸ”¹ GELÄ°R GÄ°DER GRAFÄ°ÄžÄ°
              const GraphCard(),

              const SizedBox(height: 16),

              // ðŸ”¹ SON Ä°ÅžLEMLER
              _buildTransactionList(),
            ],
          ),
        ),
      ),
    );
  }

  // ------------------------------------------
  // NAV BAR WIDGET
  Widget _navButton(BuildContext context,
    {required IconData icon,
    required String label,
    bool isActive = false,
    required VoidCallback onTap}) {
    return Padding(
      padding: const EdgeInsets.only(right: 8),
      child: GestureDetector(
        onTap: onTap,
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
          decoration: BoxDecoration(
            color: isActive ? Colors.black : Colors.transparent,
            borderRadius: BorderRadius.circular(10),
          ),
          child: Row(
            children: [
              Icon(icon,
                  size: 18,
                  color: isActive ? Colors.white : Colors.black87),
              const SizedBox(width: 6),
              Text(
                label,
                style: TextStyle(
                  color: isActive ? Colors.white : Colors.black87,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // ------------------------------------------
  // ðŸ”¸ BANKA KARTI
  Widget _buildBankCard(String name, double amount, Color color) {
    final currencyFormat = NumberFormat.currency(locale: 'tr_TR', symbol: 'â‚º');
    return Card(
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: color, width: 2),
      ),
      margin: const EdgeInsets.only(bottom: 10),
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(children: [
              const Icon(Icons.account_balance_outlined),
              const SizedBox(width: 8),
              Text(name, style: const TextStyle(fontSize: 16)),
            ]),
            Text(currencyFormat.format(amount),
                style:
                    const TextStyle(fontWeight: FontWeight.w600, fontSize: 15)),
          ],
        ),
      ),
    );
  }

  // ------------------------------------------
  // ðŸ”¸ BÃœTÃ‡E KARTI
  Widget _buildBudgetCard(BuildContext context, {required double spent, required double total}) {
    final double percent = (spent / total).clamp(0.0, 1.0).toDouble();
    final percentText = (percent * 100).toStringAsFixed(0);

    return GestureDetector(
      onTap: () {
        showDialog(
          context: context,
          builder: (context) => const ShowBudgetPopup(),
        );
      },
      child: Card(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        margin: const EdgeInsets.only(bottom: 6),
        child: Padding(
          padding: const EdgeInsets.all(14),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("AylÄ±k BÃ¼tÃ§e",
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
              const SizedBox(height: 8),
              Text("Harcanan â‚º${spent.toStringAsFixed(0)} / â‚º${total.toStringAsFixed(0)}"),
              const SizedBox(height: 6),
              ClipRRect(
                borderRadius: BorderRadius.circular(10),
                child: LinearProgressIndicator(
                  value: percent,
                  minHeight: 6,
                  color: Colors.black87,
                  backgroundColor: Colors.grey[300],
                ),
              ),
              const SizedBox(height: 4),
              Text("%$percentText"),
            ],
          ),
        ),
      ),
    );
  }

  // ------------------------------------------
  // ðŸ”¸ NET DEÄžER KARTI
  Widget _buildNetWorthCard(double total) {
    final currencyFormat = NumberFormat.currency(locale: 'tr_TR', symbol: 'â‚º');
    return Card(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      margin: const EdgeInsets.only(bottom: 6),
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("Net DeÄŸer",
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
            const SizedBox(height: 4),
            Text(currencyFormat.format(total),
                style:
                    const TextStyle(fontSize: 18, fontWeight: FontWeight.w600)),
            const SizedBox(height: 4),
            Text("Toplam bakiye",
                style: TextStyle(color: Colors.grey.shade600, fontSize: 13)),
          ],
        ),
      ),
    );
  }

  // ------------------------------------------
  // ðŸ”¸ SON Ä°ÅžLEMLER
  Widget _buildTransactionList() {
    final transactions = [
      {
        "title": "Market AlÄ±ÅŸveriÅŸi",
        "bank": "Ziraat BankasÄ±",
        "type": "AlÄ±ÅŸveriÅŸ",
        "amount": -350,
        "date": "2025-11-01"
      },
      {
        "title": "MaaÅŸ",
        "bank": "Ziraat BankasÄ±",
        "type": "Gelir",
        "amount": 15000,
        "date": "2025-11-01"
      },
      {
        "title": "AkaryakÄ±t",
        "bank": "Ziraat BankasÄ±",
        "type": "UlaÅŸÄ±m",
        "amount": -200,
        "date": "2025-11-02"
      },
    ];

    return Card(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      margin: const EdgeInsets.only(bottom: 20),
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("Son Ä°ÅŸlemler",
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
            const SizedBox(height: 8),
            ...transactions.map((tx) {
              final amount = tx["amount"] as num;
              final color = amount > 0 ? Colors.green : Colors.red;
              return Padding(
                padding: const EdgeInsets.symmetric(vertical: 6),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(tx["title"].toString(),
                              style:
                                  const TextStyle(fontWeight: FontWeight.w500)),
                          Text(
                            "${tx["bank"]} â€¢ ${tx["type"]} â€¢ ${tx["date"]}",
                            style: const TextStyle(
                                fontSize: 12, color: Colors.grey),
                          ),
                        ]),
                    Text(
                      "${amount > 0 ? '+' : ''}â‚º$amount",
                      style: TextStyle(color: color, fontWeight: FontWeight.w600),
                    ),
                  ],
                ),
              );
            }),
          ],
        ),
      ),
    );
  }
}
